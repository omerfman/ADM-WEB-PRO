/**
 * Firestore Rules for ADM Construction Project Management System
 * Role-Based Access Control with proper rule enforcement
 */

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function getUserRole() {
      return request.auth.token.role;
    }

    function getUserCompanyId() {
      return request.auth.token.companyId;
    }

    function isSuperAdmin() {
      return getUserRole() == 'super_admin';
    }

    function isCompanyAdmin() {
      return getUserRole() == 'company_admin';
    }

    function isCompanyUser() {
      return getUserRole() == 'user';
    }
    
    function isClient() {
      return getUserRole() == 'client';
    }
    
    function isAdminRole() {
      return isSuperAdmin() || isCompanyAdmin();
    }

    // Note: hasCompanyAccess not used for hakediş collections (super_admin has null companyId)
    // Keeping for future use in other collections
    function hasCompanyAccess(companyId) {
      return isSignedIn() && (isSuperAdmin() || getUserCompanyId() == companyId);
    }
    
    // Check if client has access to specific project
    function clientHasProjectAccess(projectId) {
      return isClient() && 
             exists(/databases/$(database)/documents/projects/$(projectId)) &&
             request.auth.uid in get(/databases/$(database)/documents/projects/$(projectId)).data.allowedClients;
    }

    // ========== COMPANIES COLLECTION ==========
    match /companies/{companyId} {
      // All authenticated users can read
      allow read: if isSignedIn();
      // Only super admin can create
      allow create: if isSuperAdmin() && 
                       request.resource.data.name != null;
      // All authenticated users can update
      allow update: if isSignedIn();
      // Only super admin can delete
      allow delete: if isSuperAdmin();
    }

    // ========== USERS COLLECTION ==========
    match /users/{userId} {
      // Read: All authenticated users can read users in their company
      // Clients can only read their own profile
      allow read: if isSignedIn() && (
        !isClient() || 
        userId == request.auth.uid
      );
      
      // Create: Only admins can create users (including clients)
      allow create: if isAdminRole() && 
                       request.resource.data.email != null;
      
      // Update: Admins can update all users, clients can update only their own profile (limited fields)
      allow update: if isSignedIn() && (
        isAdminRole() ||
        (isClient() && userId == request.auth.uid && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'companyId', 'authorizedProjects']))
      );
      
      // Delete: Only admins can delete users
      allow delete: if isAdminRole();
    }

    // ========== PROJECTS COLLECTION ==========
    match /projects/{projectId} {
      // Read: Company users + authorized clients can read
      allow read: if isSignedIn() && (
        !isClient() || 
        request.auth.uid in resource.data.get('allowedClients', [])
      );
      
      // Create: Only admins and company users (not clients)
      allow create: if isSignedIn() && !isClient() &&
                       request.resource.data.companyId != null;
      
      // Update: Only admins and company users (not clients)
      allow update: if isSignedIn() && !isClient();
      
      // Delete: Only admins (not clients or regular users)
      allow delete: if isAdminRole();

      // ========== PROJECT SUBCOLLECTIONS ==========
      match /logs/{logId} {
        // Clients can read logs if they have project access
        allow read: if isSignedIn() && (
          !isClient() || 
          clientHasProjectAccess(projectId)
        );
        // Only non-clients can write
        allow create, update, delete: if isSignedIn() && !isClient();
      }

      match /stocks/{stockId} {
        // Stocks visible only to non-clients (company internal data)
        allow read: if isSignedIn() && !isClient();
        allow create, update, delete: if isSignedIn() && !isClient();
      }

      match /payments/{paymentId} {
        // Clients can read payments if visibility is enabled and they have project access
        allow read: if isSignedIn() && (
          !isClient() || 
          (clientHasProjectAccess(projectId) && 
           get(/databases/$(database)/documents/projects/$(projectId)).data.get('clientVisibility', {}).get('showPayments', false))
        );
        allow create, update, delete: if isSignedIn() && !isClient();
      }

      match /uploads/{uploadId} {
        // Clients can view uploads if they have project access
        allow read: if isSignedIn() && (
          !isClient() || 
          clientHasProjectAccess(projectId)
        );
        allow create, delete: if isSignedIn() && !isClient();
      }

      match /photos/{photoId} {
        // Clients can view photos if they have project access
        allow read: if isSignedIn() && (
          !isClient() || 
          clientHasProjectAccess(projectId)
        );
        allow create, delete: if isSignedIn() && !isClient();
      }

      match /budget_categories/{categoryId} {
        // Budget hidden from clients
        allow read: if isSignedIn() && !isClient();
        allow create, update, delete: if isSignedIn() && !isClient();
      }

      match /budget_expenses/{expenseId} {
        // Expenses hidden from clients
        allow read: if isSignedIn() && !isClient();
        allow create, update, delete: if isSignedIn() && !isClient();
      }
    }

    // ========== AUDIT LOGS ==========
    match /audit_logs/{auditId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn();
    }

    // ========== ACTIVITY LOGS ==========
    match /activity_logs/{activityId} {
      // Read: Super admin sees all, company admin sees company logs, user sees own logs
      allow read: if isSignedIn() && (
        isSuperAdmin() || 
        resource.data.companyId == getUserCompanyId() ||
        resource.data.userId == request.auth.uid
      );
      // Write: All authenticated users can create activity logs
      allow create: if isSignedIn() && request.resource.data.userId != null;
      // Update/Delete: Only super admin
      allow update, delete: if isSuperAdmin();
    }

    // ========== ROOT-LEVEL PROJECT-RELATED COLLECTIONS ==========
    // These are used by the application instead of subcollections
    
    // Logs (Root-level)
    match /logs/{logId} {
      allow read: if isSignedIn() && !isClient();
      allow create, update, delete: if isSignedIn() && !isClient();
    }

    // Stocks (Root-level)
    match /stocks/{stockId} {
      allow read: if isSignedIn() && !isClient();
      allow create, update, delete: if isSignedIn() && !isClient();
    }

    // Payments (Root-level)
    match /payments/{paymentId} {
      allow read: if isSignedIn() && !isClient();
      allow create, update, delete: if isSignedIn() && !isClient();
    }

    // Budget Categories (Root-level)
    match /budget_categories/{categoryId} {
      allow read: if isSignedIn() && !isClient();
      allow create, update, delete: if isSignedIn() && !isClient();
    }

    // Budget Expenses (Root-level)
    match /budget_expenses/{expenseId} {
      allow read: if isSignedIn() && !isClient();
      allow create, update, delete: if isSignedIn() && !isClient();
    }

    // ========== WORKFLOW COLLECTIONS (KEŞİF → TEKLİF → SÖZLEŞME → METRAJ → HAKEDİŞ → ÖDEME) ==========
    
    // Keşif Items (Preliminary Survey Items)
    match /kesif_items/{itemId} {
      // Clients cannot see keşif details (internal cost estimation)
      allow read: if isSignedIn() && !isClient();
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // Keşif Metadata (Survey Summary Data)
    match /kesif_metadata/{metadataId} {
      // Clients cannot see keşif metadata (internal data)
      allow read: if isSignedIn() && !isClient();
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // Proposal Items (Teklif Kalemleri)
    match /proposal_items/{itemId} {
      // Clients can read proposal items if they have project access
      allow read: if isSignedIn() && (
        !isClient() ||
        (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
         request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('allowedClients', []))
      );
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // Proposals (Teklif Dökümanları)
    match /proposals/{proposalId} {
      // Clients can read proposals if they have project access
      allow read: if isSignedIn() && (
        !isClient() ||
        (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
         request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('allowedClients', []))
      );
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // Contract Items (Sözleşme Kalemleri)
    match /contract_items/{itemId} {
      // Clients can read contract items if they have project access
      allow read: if isSignedIn() && (
        !isClient() ||
        (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
         request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('allowedClients', []))
      );
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // Contracts (Sözleşme Dökümanları)
    match /contracts/{contractId} {
      // Clients can read contracts if they have project access
      allow read: if isSignedIn() && (
        !isClient() ||
        (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
         request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('allowedClients', []))
      );
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // Payment Records (Ödeme Kayıtları)
    match /payment_records/{recordId} {
      // Clients can read payment records if they have project access and visibility is enabled
      allow read: if isSignedIn() && (
        !isClient() ||
        (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
         request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('allowedClients', []) &&
         get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('clientVisibility', {}).get('showPayments', false))
      );
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // ========== HAKEDIŞ (PROGRESS PAYMENT) COLLECTIONS ==========
    
    // BOQ Items (Bill of Quantities)
    match /boq_items/{itemId} {
      // Clients cannot see BOQ details (internal pricing)
      allow read: if isSignedIn() && !isClient();
      allow create, update: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
      allow delete: if isSuperAdmin();
    }

    // Progress Payments (Hakediş Dönemleri)
    match /progress_payments/{paymentId} {
      // Clients can read if they have project access and visibility is enabled
      allow read: if isSignedIn() && (
        !isClient() ||
        (exists(/databases/$(database)/documents/projects/$(resource.data.projectId)) &&
         request.auth.uid in get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('allowedClients', []) &&
         get(/databases/$(database)/documents/projects/$(resource.data.projectId)).data.get('clientVisibility', {}).get('showPayments', false))
      );
      allow create: if isSignedIn() && !isClient() && (isCompanyAdmin() || isCompanyUser() || isSuperAdmin());
      allow update: if isSignedIn() && !isClient() && (
        isCompanyAdmin() || 
        isSuperAdmin() ||
        (isCompanyUser() && resource.data.status == 'draft')
      );
      allow delete: if isSuperAdmin();
    }

    // Measurement Lines (Metraj Satırları)
    match /measurement_lines/{lineId} {
      // Clients cannot see measurement details (internal data)
      allow read: if isSignedIn() && !isClient();
      allow create, update: if isSignedIn() && !isClient() && (
        isCompanyAdmin() || 
        isCompanyUser() || 
        isSuperAdmin()
      );
      allow delete: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
    }

    // Payment Config (Proje Bazlı Ayarlar)
    match /payment_config/{configId} {
      // Clients cannot see payment config (internal settings)
      allow read: if isSignedIn() && !isClient();
      allow create, update, delete: if isSignedIn() && !isClient() && (
        isCompanyAdmin() || 
        isSuperAdmin()
      );
    }

    // Payment Approvals (Onay Logları - Audit Trail)
    match /payment_approvals/{approvalId} {
      // Clients cannot see approval workflow (internal process)
      allow read: if isSignedIn() && !isClient();
      allow create: if isSignedIn() && !isClient() && (isCompanyAdmin() || isSuperAdmin());
      // No updates or deletes - this is an audit trail
      allow update, delete: if false;
    }

    // ========== DEFAULT: DENY ALL ==========
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
