<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S√∂zle≈üme - ADM ƒ∞n≈üaat Proje Y√∂netim Sistemi</title>
  <link rel="stylesheet" href="../css/style.css?v=9">
</head>
<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="logo">
          <span class="logo-icon">üèóÔ∏è</span>
          <span class="logo-text">ADM Proje</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">MEN√ú</div>
          <a href="../anasayfa.html" class="nav-item">
            <span class="nav-icon">üè†</span>
            <span class="nav-text">Ana Sayfa</span>
          </a>
          <a href="../projeler.html" class="nav-item">
            <span class="nav-icon">üìä</span>
            <span class="nav-text">Projeler</span>
          </a>
          <a href="../sirketler.html" class="nav-item">
            <span class="nav-icon">üè¢</span>
            <span class="nav-text">≈ûirketler</span>
          </a>
          <a href="../kullanicilar.html" class="nav-item">
            <span class="nav-icon">üë•</span>
            <span class="nav-text">Kullanƒ±cƒ±lar</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">PROJE</div>
          <a href="proje-ozeti.html" class="nav-item" id="navOzet">
            <span class="nav-icon">üìä</span>
            <span class="nav-text">Proje √ñzeti</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">ƒ∞≈û AKI≈ûI</div>
          <a href="kesif.html" class="nav-item" id="navKesif">
            <span class="nav-icon">üîç</span>
            <span class="nav-text">1. Ke≈üif</span>
          </a>
          <a href="teklif.html" class="nav-item" id="navTeklif">
            <span class="nav-icon">üíº</span>
            <span class="nav-text">2. Teklif</span>
          </a>
          <a href="#" class="nav-item active">
            <span class="nav-icon">üìù</span>
            <span class="nav-text">3. S√∂zle≈üme</span>
          </a>
          <a href="metraj-listesi.html" class="nav-item" id="navMetraj">
            <span class="nav-icon">üìê</span>
            <span class="nav-text">4. Metraj</span>
          </a>
          <a href="hakedis-takibi.html" class="nav-item" id="navHakedis">
            <span class="nav-icon">üí∞</span>
            <span class="nav-text">5. Hakedi≈ü</span>
          </a>
          <a href="odeme-takibi.html" class="nav-item" id="navOdeme">
            <span class="nav-icon">üí≥</span>
            <span class="nav-text">6. √ñdeme</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">DESTEK</div>
          <a href="proje-ozeti.html" class="nav-item" id="navOzet">
            <span class="nav-icon">üìä</span>
            <span class="nav-text">Proje √ñzeti</span>
          </a>
          <a href="stok-yonetimi.html" class="nav-item" id="navStok">
            <span class="nav-icon">üì¶</span>
            <span class="nav-text">Stok Y√∂netimi</span>
          </a>
          <a href="butce-yonetimi.html" class="nav-item" id="navButce">
            <span class="nav-icon">üíµ</span>
            <span class="nav-text">B√ºt√ße Y√∂netimi</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-profile">
          <div class="user-avatar">A</div>
          <div class="user-info">
            <div class="user-name" id="sidebarUserName">Admin</div>
            <div class="user-role" id="sidebarUserRole">Y√∂netici</div>
          </div>
        </div>
        <button class="btn btn-secondary" style="width: 100%; margin-top: 1rem;" onclick="handleLogout()">
          üö™ √áƒ±kƒ±≈ü Yap
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <div class="topbar">
        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
          <button class="menu-toggle" id="menuToggle">‚ò∞</button>
          <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
            <a href="../anasayfa.html" style="color: var(--text-secondary); text-decoration: none;">Anasayfa</a>
            <span>‚Ä∫</span>
            <a href="../projeler.html" style="color: var(--text-secondary); text-decoration: none;">Projeler</a>
            <span>‚Ä∫</span>
            <span id="projectNameBreadcrumb" style="color: var(--brand-red); font-weight: 600;">Y√ºkleniyor...</span>
          </div>
        </div>
        <div class="topbar-actions">
          <button class="btn" onclick="exportContractPDF()">
            üìÑ PDF ƒ∞ndir
          </button>
          <button class="btn" onclick="signContract()" id="signBtn">
            ‚úçÔ∏è ƒ∞mzala
          </button>
          <button class="btn btn-primary" onclick="activateContract()" id="activateBtn" style="display: none;">
            ‚úÖ S√∂zle≈ümeyi Aktifle≈ütir
          </button>
          <span id="userNameDisplay" class="topbar-user"></span>
        </div>
      </div>

      <div id="alertContainer"></div>

      <!-- Content Section -->
      <section class="content-section">
        <!-- Project Header -->
        <div style="background: linear-gradient(135deg, var(--brand-red) 0%, var(--brand-red-dark) 100%); color: white; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
            <div style="flex: 1;">
              <h2 id="projectName" style="margin: 0; font-size: 1.5rem;">Y√ºkleniyor...</h2>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="window.location.href='../projeler.html'">
                ‚Üê Projelere D√∂n
              </button>
            </div>
          </div>
        </div>

        <!-- Header -->
        <div style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); color: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem;">
          <h1 style="margin: 0 0 0.5rem 0; font-size: 1.5rem;">üìù S√∂zle≈üme</h1>
          <p style="margin: 0 0 1rem 0; opacity: 0.9;">Resmi proje s√∂zle≈ümesi</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; opacity: 0.9;">S√∂zle≈üme No</h4>
              <div style="font-size: 1.2rem; font-weight: bold;" id="contractNo">-</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; opacity: 0.9;">S√∂zle≈üme Tutarƒ±</h4>
              <div style="font-size: 1.2rem; font-weight: bold;" id="contractAmount">‚Ç∫0.00</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; opacity: 0.9;">Ba≈ülangƒ±√ß</h4>
              <div style="font-size: 1.2rem; font-weight: bold;" id="startDate">-</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; opacity: 0.9;">Biti≈ü</h4>
              <div style="font-size: 1.2rem; font-weight: bold;" id="endDate">-</div>
            </div>
            <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; backdrop-filter: blur(10px);">
              <h4 style="margin: 0 0 0.5rem 0; font-size: 0.85rem; opacity: 0.9;">Durum</h4>
              <div style="font-size: 1.2rem; font-weight: bold;" id="contractStatus">Taslak</div>
            </div>
          </div>
        </div>

        <!-- Contract Details -->
        <div class="card">
          <h2 style="margin: 0 0 1.5rem 0;">üìã S√∂zle≈üme Bilgileri</h2>
          
          <div class="detail-row">
            <div class="detail-label">S√∂zle≈üme T√ºr√º:</div>
            <div class="detail-value">
              <select id="contractType" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
                <option value="fixed">G√∂t√ºr√º Bedel</option>
                <option value="unit">Birim Fiyat</option>
                <option value="cost_plus">Maliyet + K√¢r</option>
              </select>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">ƒ∞≈üveren (M√º≈üteri):</div>
            <div class="detail-value" id="clientName">-</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Y√ºklenici (Firma):</div>
            <div class="detail-value" id="companyName">-</div>
          </div>

          <div class="detail-row">
            <div class="detail-label">S√∂zle≈üme Tarihi:</div>
            <div class="detail-value">
              <input type="date" id="contractDate" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">ƒ∞≈üe Ba≈ülama Tarihi:</div>
            <div class="detail-value">
              <input type="date" id="workStartDate" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Tamamlanma S√ºresi:</div>
            <div class="detail-value">
              <input type="number" id="durationDays" placeholder="G√ºn sayƒ±sƒ±" min="1" style="width: 150px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
              <span style="margin-left: 0.5rem;">g√ºn</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Gecikme Cezasƒ±:</div>
            <div class="detail-value">
              <input type="number" id="penaltyRate" value="0.001" step="0.0001" min="0" max="0.01" style="width: 150px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
              <span style="margin-left: 0.5rem;">g√ºnl√ºk oran (‚Ä∞)</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Ge√ßici Kabul S√ºresi:</div>
            <div class="detail-value">
              <input type="number" id="provisionalAcceptance" value="15" min="1" style="width: 150px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
              <span style="margin-left: 0.5rem;">g√ºn</span>
            </div>
          </div>

          <div class="detail-row">
            <div class="detail-label">Kesin Kabul S√ºresi:</div>
            <div class="detail-value">
              <input type="number" id="finalAcceptance" value="365" min="1" style="width: 150px; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
              <span style="margin-left: 0.5rem;">g√ºn</span>
            </div>
          </div>

          <button class="btn btn-primary" onclick="saveContractDetails()" style="margin-top: 1.5rem;">
            üíæ Bilgileri Kaydet
          </button>
        </div>

        <!-- Contract Items -->
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2 style="margin: 0;">üìã S√∂zle≈üme Kalemleri (Locked BOQ)</h2>
            <div style="color: var(--text-secondary); font-size: 0.9rem;">
              ‚ÑπÔ∏è Bu kalemler s√∂zle≈üme imzalandƒ±ktan sonra kilitlenir
            </div>
          </div>

          <div class="table-responsive">
            <table class="data-table" id="contractTable" style="width: 100%; min-width: 800px;">
              <thead>
                <tr>
                  <th style="min-width: 50px;">Poz</th>
                  <th style="min-width: 250px;">ƒ∞≈ü Kalemi</th>
                  <th style="min-width: 80px;">Birim</th>
                  <th style="text-align: right; min-width: 100px;">S√∂zle≈üme Miktarƒ±</th>
                  <th style="text-align: right; min-width: 120px;">Birim Fiyat</th>
                  <th style="text-align: right; min-width: 120px;">Toplam</th>
                </tr>
              </thead>
              <tbody id="contractTableBody">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                    <p>Hen√ºz s√∂zle≈üme kalemi y√ºklenmemi≈ü</p>
                    <button class="btn btn-primary" onclick="importFromProposal()" style="margin-top: 1rem;">
                      üì• Tekliften ƒ∞√ße Aktar
                    </button>
                  </td>
                </tr>
              </tbody>
              <tfoot id="contractTableFooter" style="display: none;">
                <tr style="background: var(--bg-secondary); font-weight: bold;">
                  <td colspan="5" style="text-align: right; padding: 1rem;">TOPLAM S√ñZLE≈ûME BEDELƒ∞:</td>
                  <td style="text-align: right; color: var(--brand-red); font-size: 1.2rem;" id="footerTotal">‚Ç∫0.00</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Payment Terms -->
        <div class="card" style="margin-top: 1.5rem;">
          <h3 style="margin: 0 0 1rem 0;">üí∞ √ñdeme ≈ûartlarƒ±</h3>
          <div class="form-grid">
            <div class="form-group">
              <label>√ñdeme Tipi</label>
              <select id="paymentType" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
                <option value="progress">Hakedi≈ü Sistemli</option>
                <option value="milestone">Kilometre Ta≈üƒ±</option>
                <option value="advance">Pe≈üin √ñdeme</option>
              </select>
            </div>
            <div class="form-group">
              <label>Avans Oranƒ± (%)</label>
              <input type="number" id="advancePayment" value="0" min="0" max="100" step="1" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
            <div class="form-group">
              <label>Hakedi≈ü Kesinti Oranƒ± (%)</label>
              <input type="number" id="retentionRate" value="10" min="0" max="100" step="1" style="padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 6px;">
            </div>
          </div>
          <div class="form-group" style="margin-top: 1rem;">
            <label>√ñdeme ≈ûartlarƒ± Detayƒ±</label>
            <textarea id="paymentTerms" rows="4" style="width: 100%; padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px;" placeholder="√ñdeme d√∂nemleri, ≈üartlar, bankalar vb..."></textarea>
          </div>
        </div>

        <!-- Contract Clauses -->
        <div class="card" style="margin-top: 1.5rem;">
          <h3 style="margin: 0 0 1rem 0;">üìú S√∂zle≈üme Maddeleri</h3>
          <textarea id="contractClauses" rows="10" style="width: 100%; padding: 1rem; border: 1px solid var(--border-color); border-radius: 6px; font-family: inherit;" placeholder="S√∂zle≈üme maddeleri, √∂zel ≈üartlar, sorumluluklar..."></textarea>
          <button class="btn btn-primary" onclick="saveContractClauses()" style="margin-top: 1rem;">
            üíæ Maddeleri Kaydet
          </button>
        </div>

        <!-- Signatures -->
        <div class="signature-section">
          <h3 style="margin: 0 0 1rem 0;">‚úçÔ∏è ƒ∞mzalar</h3>
          <div class="signature-box">
            <div class="signature-item">
              <h4>ƒ∞≈ûVEREN</h4>
              <div class="signature-placeholder" id="clientSignature">ƒ∞mza Bekleniyor</div>
              <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);" id="clientSignDate">-</div>
            </div>
            <div class="signature-item">
              <h4>Y√úKLENƒ∞Cƒ∞</h4>
              <div class="signature-placeholder" id="contractorSignature">ƒ∞mza Bekleniyor</div>
              <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-secondary);" id="contractorSignDate">-</div>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Scripts -->
  <script type="module" src="../js/auth.js?v=6"></script>
  <script type="module" src="../js/projects.js?v=6"></script>
  <script type="module" src="../js/app.js?v=6"></script>

  <script>
    document.getElementById('menuToggle')?.addEventListener('click', function() {
      document.querySelector('.sidebar').classList.toggle('sidebar-open');
    });

    function updateNavLinks() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      if (projectId) {
        // ƒ∞≈ü Akƒ±≈üƒ± Linkleri
        const navKesif = document.getElementById('navKesif');
        const navTeklif = document.getElementById('navTeklif');
        const navSozlesme = document.getElementById('navSozlesme');
        const navMetraj = document.getElementById('navMetraj');
        const navHakedis = document.getElementById('navHakedis');
        const navOdeme = document.getElementById('navOdeme');
        // Proje & Destek Linkleri
        const navOzet = document.getElementById('navOzet');
        const navStok = document.getElementById('navStok');
        const navButce = document.getElementById('navButce');
        const navGunluk = document.getElementById('navGunluk');
        const navMusteri = document.getElementById('navMusteri');
        
        if (navKesif) navKesif.href = `kesif.html?id=${projectId}`;
        if (navTeklif) navTeklif.href = `teklif.html?id=${projectId}`;
        if (navSozlesme) navSozlesme.href = `sozlesme.html?id=${projectId}`;
        if (navMetraj) navMetraj.href = `metraj-listesi.html?id=${projectId}`;
        if (navHakedis) navHakedis.href = `hakedis-takibi.html?id=${projectId}`;
        if (navOdeme) navOdeme.href = `odeme-takibi.html?id=${projectId}`;
        if (navOzet) navOzet.href = `proje-ozeti.html?id=${projectId}`;
        if (navStok) navStok.href = `stok-yonetimi.html?id=${projectId}`;
        if (navButce) navButce.href = `butce-yonetimi.html?id=${projectId}`;
        if (navGunluk) navGunluk.href = `santiye-gunlugu.html?id=${projectId}`;
        if (navMusteri) navMusteri.href = `musteri-yetkileri.html?id=${projectId}`;
      }
    }

    function importFromProposal() {
      if (window.loadFromProposal) {
        window.loadFromProposal();
      }
    }

    function saveContractDetails() {
      if (window.updateContractDetails) {
        window.updateContractDetails();
      }
    }

    function saveContractClauses() {
      const clauses = document.getElementById('contractClauses').value;
      if (window.updateContractClauses) {
        window.updateContractClauses(clauses);
      }
    }

    function signContract() {
      if (confirm('S√∂zle≈ümeyi imzalamak istediƒüinize emin misiniz?')) {
        if (window.markContractSigned) {
          window.markContractSigned();
        }
      }
    }

    function activateContract() {
      if (confirm('S√∂zle≈ümeyi aktifle≈ütirmek istediƒüinize emin misiniz? Bu i≈ülem geri alƒ±namaz.')) {
        if (window.activateContractStatus) {
          window.activateContractStatus();
        }
      }
    }

    function exportContractPDF() {
      if (window.generateContractPDF) {
        window.generateContractPDF();
      } else {
        alert('PDF export √∂zelliƒüi yakƒ±nda eklenecek');
      }
    }

    updateNavLinks();
  </script>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, setDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    let currentProjectId = null;
    let contractItems = [];
    let contractData = {};

    async function loadContract() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      const fromProposal = urlParams.get('from');
      
      if (!projectId) {
        window.location.href = '../projeler.html';
        return;
      }

      currentProjectId = projectId;

      try {
        const projectDoc = await getDoc(doc(db, 'projects', projectId));
        if (!projectDoc.exists()) {
          alert('‚ùå Proje bulunamadƒ±');
          window.location.href = '../projeler.html';
          return;
        }

        const project = { id: projectDoc.id, ...projectDoc.data() };
        document.getElementById('projectName').textContent = project.name || 'Proje';
        document.getElementById('projectNameBreadcrumb').textContent = project.name || 'Proje';
        document.getElementById('clientName').textContent = project.clientName || '-';
        document.getElementById('companyName').textContent = project.companyName || '-';

        // Check if coming from proposal
        if (fromProposal === 'proposal') {
          const proposalData = sessionStorage.getItem('proposalToContract');
          if (proposalData) {
            await importProposalData(JSON.parse(proposalData));
            sessionStorage.removeItem('proposalToContract');
          }
        }

        // Load contract metadata
        const contractDocRef = doc(db, 'contracts', projectId);
        const contractDoc = await getDoc(contractDocRef);
        
        if (contractDoc.exists()) {
          contractData = contractDoc.data();
          
          document.getElementById('contractNo').textContent = contractData.contractNo || '-';
          document.getElementById('contractAmount').textContent = formatCurrency(contractData.contractAmount || 0);
          
          if (contractData.contractDate) {
            document.getElementById('contractDate').value = contractData.contractDate;
            document.getElementById('startDate').textContent = new Date(contractData.contractDate).toLocaleDateString('tr-TR');
          }
          
          if (contractData.workStartDate) {
            document.getElementById('workStartDate').value = contractData.workStartDate;
          }
          
          if (contractData.durationDays) {
            document.getElementById('durationDays').value = contractData.durationDays;
            const endDate = new Date(contractData.workStartDate);
            endDate.setDate(endDate.getDate() + contractData.durationDays);
            document.getElementById('endDate').textContent = endDate.toLocaleDateString('tr-TR');
          }

          if (contractData.contractType) document.getElementById('contractType').value = contractData.contractType;
          if (contractData.penaltyRate !== undefined) document.getElementById('penaltyRate').value = contractData.penaltyRate;
          if (contractData.provisionalAcceptance) document.getElementById('provisionalAcceptance').value = contractData.provisionalAcceptance;
          if (contractData.finalAcceptance) document.getElementById('finalAcceptance').value = contractData.finalAcceptance;
          if (contractData.paymentType) document.getElementById('paymentType').value = contractData.paymentType;
          if (contractData.advancePayment !== undefined) document.getElementById('advancePayment').value = contractData.advancePayment;
          if (contractData.retentionRate !== undefined) document.getElementById('retentionRate').value = contractData.retentionRate;
          if (contractData.paymentTerms) document.getElementById('paymentTerms').value = contractData.paymentTerms;
          if (contractData.clauses) document.getElementById('contractClauses').value = contractData.clauses;

          const statusMap = {
            draft: 'Taslak',
            pending: 'Onay Bekliyor',
            signed: 'ƒ∞mzalandƒ±',
            active: 'Aktif',
            completed: 'Tamamlandƒ±',
            terminated: 'Feshedildi'
          };
          document.getElementById('contractStatus').textContent = statusMap[contractData.status] || 'Taslak';

          // Show activate button if signed
          if (contractData.status === 'signed') {
            document.getElementById('activateBtn').style.display = 'inline-block';
          }

          // Show signatures
          if (contractData.clientSignedAt) {
            document.getElementById('clientSignature').innerHTML = '<strong>‚úÖ ƒ∞mzalandƒ±</strong>';
            document.getElementById('clientSignDate').textContent = contractData.clientSignedAt.toDate().toLocaleString('tr-TR');
          }
          if (contractData.contractorSignedAt) {
            document.getElementById('contractorSignature').innerHTML = '<strong>‚úÖ ƒ∞mzalandƒ±</strong>';
            document.getElementById('contractorSignDate').textContent = contractData.contractorSignedAt.toDate().toLocaleString('tr-TR');
          }
        }

        // Load contract items
        const itemsQuery = query(
          collection(db, 'contract_items'),
          where('projectId', '==', projectId),
          where('isDeleted', '==', false),
          orderBy('pozNo', 'asc')
        );
        const itemsSnap = await getDocs(itemsQuery);
        contractItems = [];
        
        itemsSnap.forEach(docSnap => {
          contractItems.push({ id: docSnap.id, ...docSnap.data() });
        });

        renderContractTable();

      } catch (error) {
        console.error('‚ùå Error loading contract:', error);
        alert('S√∂zle≈üme verileri y√ºklenirken hata: ' + error.message);
      }
    }

    async function importProposalData(proposalData) {
      try {
        const user = auth.currentUser;
        let totalAmount = 0;

        // Import items
        for (let i = 0; i < proposalData.items.length; i++) {
          const item = proposalData.items[i];
          const itemTotal = (item.quantity || 0) * (item.unitPrice || 0);
          totalAmount += itemTotal;

          await addDoc(collection(db, 'contract_items'), {
            projectId: currentProjectId,
            pozNo: i + 1,
            name: item.name,
            category: item.category,
            unit: item.unit,
            contractQuantity: item.quantity,
            unitPrice: item.unitPrice,
            description: item.description,
            fromProposalId: proposalData.proposalId,
            isLocked: false,
            isDeleted: false,
            createdAt: Timestamp.now(),
            createdBy: user.uid
          });
        }

        // Create contract metadata
        const contractDocRef = doc(db, 'contracts', currentProjectId);
        await setDoc(contractDocRef, {
          projectId: currentProjectId,
          contractNo: `SZL-${Date.now()}`,
          contractAmount: totalAmount,
          contractType: 'fixed',
          penaltyRate: 0.001,
          provisionalAcceptance: 15,
          finalAcceptance: 365,
          paymentType: 'progress',
          advancePayment: 0,
          retentionRate: 10,
          status: 'draft',
          createdAt: Timestamp.now(),
          createdBy: user.uid
        });

        alert('‚úÖ Teklif verileri ba≈üarƒ±yla aktarƒ±ldƒ±!');

      } catch (error) {
        console.error('‚ùå Error importing proposal:', error);
        alert('Teklif verileri aktarƒ±lƒ±rken hata: ' + error.message);
      }
    }

    function renderContractTable() {
      const tbody = document.getElementById('contractTableBody');
      const footer = document.getElementById('contractTableFooter');

      if (contractItems.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
              <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
              <p>Hen√ºz s√∂zle≈üme kalemi y√ºklenmemi≈ü</p>
              <button class="btn btn-primary" onclick="importFromProposal()" style="margin-top: 1rem;">
                üì• Tekliften ƒ∞√ße Aktar
              </button>
            </td>
          </tr>
        `;
        footer.style.display = 'none';
        return;
      }

      let html = '';
      let totalAmount = 0;

      contractItems.forEach(item => {
        const total = (item.contractQuantity || 0) * (item.unitPrice || 0);
        totalAmount += total;

        html += `
          <tr>
            <td>${item.pozNo}</td>
            <td>
              <strong>${item.name}</strong>
              ${item.description ? `<br><small style="color: var(--text-secondary);">${item.description}</small>` : ''}
            </td>
            <td>${item.unit}</td>
            <td style="text-align: right;">${formatNumber(item.contractQuantity)}</td>
            <td style="text-align: right;">${formatCurrency(item.unitPrice)}</td>
            <td style="text-align: right;"><strong>${formatCurrency(total)}</strong></td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      footer.style.display = 'table-footer-group';
      document.getElementById('footerTotal').textContent = formatCurrency(totalAmount);
    }

    window.updateContractDetails = async function() {
      try {
        const contractDate = document.getElementById('contractDate').value;
        const workStartDate = document.getElementById('workStartDate').value;
        const durationDays = parseInt(document.getElementById('durationDays').value) || 0;

        const contractDocRef = doc(db, 'contracts', currentProjectId);
        await updateDoc(contractDocRef, {
          contractType: document.getElementById('contractType').value,
          contractDate,
          workStartDate,
          durationDays,
          penaltyRate: parseFloat(document.getElementById('penaltyRate').value),
          provisionalAcceptance: parseInt(document.getElementById('provisionalAcceptance').value),
          finalAcceptance: parseInt(document.getElementById('finalAcceptance').value),
          paymentType: document.getElementById('paymentType').value,
          advancePayment: parseFloat(document.getElementById('advancePayment').value),
          retentionRate: parseFloat(document.getElementById('retentionRate').value),
          paymentTerms: document.getElementById('paymentTerms').value
        });

        alert('‚úÖ S√∂zle≈üme bilgileri kaydedildi');
        loadContract();

      } catch (error) {
        console.error('‚ùå Error saving contract details:', error);
        alert('Bilgiler kaydedilirken hata: ' + error.message);
      }
    };

    window.updateContractClauses = async function(clauses) {
      try {
        const contractDocRef = doc(db, 'contracts', currentProjectId);
        await updateDoc(contractDocRef, { clauses });
        alert('‚úÖ S√∂zle≈üme maddeleri kaydedildi');
      } catch (error) {
        console.error('‚ùå Error saving clauses:', error);
        alert('Maddeler kaydedilirken hata: ' + error.message);
      }
    };

    window.markContractSigned = async function() {
      try {
        const contractDocRef = doc(db, 'contracts', currentProjectId);
        await updateDoc(contractDocRef, {
          status: 'signed',
          contractorSignedAt: Timestamp.now(),
          clientSignedAt: Timestamp.now()
        });

        // Lock all contract items
        for (const item of contractItems) {
          await updateDoc(doc(db, 'contract_items', item.id), {
            isLocked: true
          });
        }

        alert('‚úÖ S√∂zle≈üme imzalandƒ± ve kalemler kilitlendi');
        loadContract();

      } catch (error) {
        console.error('‚ùå Error signing contract:', error);
        alert('ƒ∞mzalama hatasƒ±: ' + error.message);
      }
    };

    window.activateContractStatus = async function() {
      try {
        const contractDocRef = doc(db, 'contracts', currentProjectId);
        await updateDoc(contractDocRef, {
          status: 'active',
          activatedAt: Timestamp.now()
        });

        // Export to BOQ (metraj)
        for (const item of contractItems) {
          await addDoc(collection(db, 'boq_items'), {
            projectId: currentProjectId,
            pozNo: item.pozNo,
            name: item.name,
            category: item.category,
            unit: item.unit,
            contractQuantity: item.contractQuantity,
            unitPrice: item.unitPrice,
            description: item.description,
            fromContractId: item.id,
            completedQuantity: 0,
            isDeleted: false,
            createdAt: Timestamp.now(),
            createdBy: auth.currentUser.uid
          });
        }

        alert('‚úÖ S√∂zle≈üme aktifle≈ütirildi ve metraj listesine aktarƒ±ldƒ±!');
        
        // Redirect to metraj page
        window.location.href = `metraj-listesi.html?id=${currentProjectId}&from=contract`;

      } catch (error) {
        console.error('‚ùå Error activating contract:', error);
        alert('Aktifle≈ütirme hatasƒ±: ' + error.message);
      }
    };

    window.loadFromProposal = async function() {
      try {
        const proposalQuery = query(
          collection(db, 'proposal_items'),
          where('projectId', '==', currentProjectId),
          where('isDeleted', '==', false)
        );
        const proposalSnap = await getDocs(proposalQuery);
        
        if (proposalSnap.empty) {
          alert('‚ùå Teklif kalemleri bulunamadƒ±');
          return;
        }

        const proposalItems = [];
        proposalSnap.forEach(doc => {
          proposalItems.push({ id: doc.id, ...doc.data() });
        });

        const proposalDocSnap = await getDoc(doc(db, 'proposals', currentProjectId));
        const proposalMetadata = proposalDocSnap.exists() ? proposalDocSnap.data() : {};

        await importProposalData({
          projectId: currentProjectId,
          proposalId: currentProjectId,
          items: proposalItems,
          metadata: proposalMetadata
        });

        loadContract();

      } catch (error) {
        console.error('‚ùå Error loading from proposal:', error);
        alert('Tekliften y√ºkleme hatasƒ±: ' + error.message);
      }
    };

    function formatCurrency(amount) {
      return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY',
        minimumFractionDigits: 2
      }).format(amount || 0);
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('tr-TR', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      }).format(num || 0);
    }

    setTimeout(() => {
      loadContract();
    }, 200);
  </script>
</body>
</html>
