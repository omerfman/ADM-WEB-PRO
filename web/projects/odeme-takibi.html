<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ã–deme Takibi - ADM Ä°nÅŸaat Proje YÃ¶netim Sistemi</title>
  <link rel="stylesheet" href="../css/style.css?v=9">
  <style>
    /* Payment status badges */
    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
    }

    .status-pending { background: #fff3e0; color: #f57c00; }
    .status-partial { background: #e3f2fd; color: #1976d2; }
    .status-paid { background: #e8f5e9; color: #388e3c; }
    .status-overdue { background: #ffebee; color: #d32f2f; }

    /* Mobile responsive table */
    @media (max-width: 768px) {
      table thead {
        display: none;
      }
      
      table tr {
        display: block;
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 1rem;
      }
      
      table td {
        display: block;
        text-align: right;
        padding: 0.5rem 0;
        border-bottom: none;
      }
      
      table td:before {
        content: attr(data-label);
        float: left;
        font-weight: 600;
        color: var(--text-secondary);
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <img src="../assets/adm_logo.png" alt="ADM Studio" class="sidebar-logo" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
        <h1 style="display: none;">ğŸ—ï¸ ADM Ä°nÅŸaat</h1>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">MENÃœ</div>
          <a href="../anasayfa.html" class="nav-item">
            <span class="nav-icon">ğŸ </span>
            <span class="nav-text">Ana Sayfa</span>
          </a>
          <a href="../projeler.html" class="nav-item">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">Projeler</span>
          </a>
          <a href="../sirketler.html" class="nav-item">
            <span class="nav-icon">ğŸ¢</span>
            <span class="nav-text">Åirketler</span>
          </a>
          <a href="../kullanicilar.html" class="nav-item">
            <span class="nav-icon">ğŸ‘¥</span>
            <span class="nav-text">KullanÄ±cÄ±lar</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Ä°Å AKIÅI</div>
          <a href="kesif.html" class="nav-item" id="navKesif">
            <span class="nav-icon">ğŸ”</span>
            <span class="nav-text">1. KeÅŸif</span>
          </a>
          <a href="teklif.html" class="nav-item" id="navTeklif">
            <span class="nav-icon">ğŸ’¼</span>
            <span class="nav-text">2. Teklif</span>
          </a>
          <a href="sozlesme.html" class="nav-item" id="navSozlesme">
            <span class="nav-icon">ğŸ“„</span>
            <span class="nav-text">3. SÃ¶zleÅŸme</span>
          </a>
          <a href="metraj-listesi.html" class="nav-item" id="navMetraj">
            <span class="nav-icon">ğŸ“</span>
            <span class="nav-text">4. Metraj</span>
          </a>
          <a href="hakedis-takibi.html" class="nav-item" id="navHakedis">
            <span class="nav-icon">ğŸ’°</span>
            <span class="nav-text">5. HakediÅŸ</span>
          </a>
          <a href="odeme-takibi.html" class="nav-item active" id="navOdeme">
            <span class="nav-icon">ğŸ’³</span>
            <span class="nav-text">6. Ã–deme</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">PROJE & DESTEK</div>
          <a href="proje-ozeti.html" class="nav-item" id="navOzet">
            <span class="nav-icon">ğŸ“Š</span>
            <span class="nav-text">Proje Ã–zeti</span>
          </a>
          <a href="stok-yonetimi.html" class="nav-item" id="navStok">
            <span class="nav-icon">ğŸ“¦</span>
            <span class="nav-text">Stok YÃ¶netimi</span>
          </a>
          <a href="butce-yonetimi.html" class="nav-item" id="navButce">
            <span class="nav-icon">ğŸ’µ</span>
            <span class="nav-text">BÃ¼tÃ§e YÃ¶netimi</span>
          </a>
          <a href="santiye-gunlugu.html" class="nav-item" id="navGunluk">
            <span class="nav-icon">ğŸ“”</span>
            <span class="nav-text">Åantiye GÃ¼nlÃ¼ÄŸÃ¼</span>
          </a>
          <a href="musteri-yetkileri.html" class="nav-item" id="navMusteri">
            <span class="nav-icon">ğŸ‘¤</span>
            <span class="nav-text">MÃ¼ÅŸteri Yetkileri</span>
          </a>
        </div>
      </nav>

      <div class="sidebar-footer">
        <div class="user-info">
          <div class="user-avatar">ğŸ‘¤</div>
          <div class="user-details">
            <div class="user-name" id="sidebarUserName">YÃ¼kleniyor...</div>
            <div class="user-role" id="sidebarUserRole">...</div>
          </div>
        </div>
        <div class="sidebar-actions">
          <button id="sidebarThemeToggle" class="theme-toggle-btn" onclick="toggleTheme()">
            <span class="theme-option light-option">
              <span class="theme-circle">âšª</span>
              <span class="theme-label">Light</span>
            </span>
            <span class="theme-option dark-option active">
              <span class="theme-circle">âš«</span>
              <span class="theme-label">Dark</span>
            </span>
          </button>
          <button id="logoutBtn" class="logout-btn" onclick="handleLogout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <!-- Top Bar -->
      <div class="topbar">
        <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
          <button class="menu-toggle" id="menuToggle">â˜°</button>
          <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
            <a href="../anasayfa.html" style="color: var(--text-secondary); text-decoration: none;">Anasayfa</a>
            <span>â€º</span>
            <a href="../projeler.html" style="color: var(--text-secondary); text-decoration: none;">Projeler</a>
            <span>â€º</span>
            <span id="projectNameBreadcrumb" style="color: var(--brand-red); font-weight: 600;">YÃ¼kleniyor...</span>
          </div>
        </div>
        <div class="topbar-actions">
          <span id="userNameDisplay" class="topbar-user"></span>
        </div>
      </div>

      <div id="alertContainer"></div>

      <!-- Project Header -->
      <section class="content-section">
        <div style="background: linear-gradient(135deg, var(--brand-red) 0%, var(--brand-red-dark) 100%); color: white; padding: 1rem 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
          <div style="display: flex; justify-content: space-between; align-items: center; gap: 1.5rem; flex-wrap: wrap;">
            <div style="flex: 1;">
              <h2 id="projectName" style="margin: 0; font-size: 1.5rem;">YÃ¼kleniyor...</h2>
              <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">HakediÅŸ tahsilat ve Ã¶deme yÃ¶netimi</p>
            </div>
            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
              <button class="btn btn-primary" onclick="openRecordPaymentModal()" style="background: white; color: var(--brand-red);">
                â• Ã–deme Kaydet
              </button>
              <button class="btn" style="background: rgba(255,255,255,0.2); color: white; border: 2px solid white; padding: 0.5rem 1rem;" onclick="window.location.href='../projeler.html'">
                â† Projelere DÃ¶n
              </button>
            </div>
          </div>
        </div>

        <!-- Summary Cards - Modern Responsive Grid -->
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
          <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem;">
            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">ğŸ’° Toplam HakediÅŸ</div>
            <div id="totalInvoiced" style="font-size: 1.8rem; font-weight: bold; margin-bottom: 0.25rem;">â‚º0.00</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">Faturalanan tutar</div>
          </div>

          <div class="card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 1.5rem;">
            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">âœ… Tahsil Edilen</div>
            <div id="totalCollected" style="font-size: 1.8rem; font-weight: bold; margin-bottom: 0.25rem;">â‚º0.00</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">Gelen Ã¶demeler</div>
          </div>

          <div class="card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 1.5rem;">
            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">â³ Bekleyen</div>
            <div id="totalPending" style="font-size: 1.8rem; font-weight: bold; margin-bottom: 0.25rem;">â‚º0.00</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">Ã–deme bekleniyor</div>
          </div>

          <div class="card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 1.5rem;">
            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">âš ï¸ Vadesi GeÃ§en</div>
            <div id="totalOverdue" style="font-size: 1.8rem; font-weight: bold; margin-bottom: 0.25rem;">â‚º0.00</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">GecikmiÅŸ tahsilat</div>
          </div>

          <div class="card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 1.5rem;">
            <div style="font-size: 0.85rem; margin-bottom: 0.5rem; opacity: 0.9;">ğŸ“Š Tahsilat OranÄ±</div>
            <div id="collectionRate" style="font-size: 1.8rem; font-weight: bold; margin-bottom: 0.25rem;">%0</div>
            <div style="font-size: 0.8rem; opacity: 0.8;">GerÃ§ekleÅŸme oranÄ±</div>
          </div>
        </div>

        <!-- Filters - Modern Card -->
        <div class="card" style="margin-bottom: 1.5rem;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600;">ğŸ” Arama</label>
              <input type="text" id="searchPayment" placeholder="HakediÅŸ ara..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-primary);">
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-size: 0.9rem; font-weight: 600;">ğŸ“Œ Durum</label>
              <select id="statusFilter" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-primary);">
                <option value="">TÃ¼m Durumlar</option>
                <option value="pending">â³ Bekleyen</option>
                <option value="partial">ğŸ“Š KÄ±smi Ã–dendi</option>
                <option value="paid">âœ… Ã–dendi</option>
                <option value="overdue">âš ï¸ Vadesi GeÃ§ti</option>
              </select>
            </div>
            <div style="display: flex; align-items: flex-end;">
              <button class="btn" onclick="window.syncFromHakedis()" style="width: 100%;">
                ğŸ”„ HakediÅŸ Senkronize Et
              </button>
            </div>
          </div>
        </div>

        <!-- Payments Table -->
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);">
            <h3 style="margin: 0;">ğŸ“‹ HakediÅŸ ve Tahsilat Listesi</h3>
            <div style="font-size: 0.9rem; color: var(--text-secondary);">
              <span id="paymentCount">0</span> kayÄ±t
            </div>
          </div>

          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; min-width: 900px;" id="paymentsTable">
              <thead>
                <tr style="background: var(--bg-secondary); border-bottom: 2px solid var(--border-color);">
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">HakediÅŸ No</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">DÃ¶nem</th>
                  <th style="padding: 1rem; text-align: right; font-weight: 600;">HakediÅŸ TutarÄ±</th>
                  <th style="padding: 1rem; text-align: right; font-weight: 600;">Ã–denen</th>
                  <th style="padding: 1rem; text-align: right; font-weight: 600;">Kalan</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Beklenen Tarih</th>
                  <th style="padding: 1rem; text-align: left; font-weight: 600;">Ã–deme Tarihi</th>
                  <th style="padding: 1rem; text-align: center; font-weight: 600;">Durum</th>
                  <th style="padding: 1rem; text-align: center; font-weight: 600; width: 150px;">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody id="paymentsTableBody">
                <tr>
                  <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’³</div>
                    <p style="margin: 0; font-size: 1.1rem;">HenÃ¼z Ã¶deme kaydÄ± yok</p>
                    <p style="margin: 0.5rem 0 0 0;">HakediÅŸ verilerini senkronize edin</p>
                  </td>
                </tr>
              </tbody>
              <tfoot id="paymentsTableFooter" style="display: none;">
                <tr style="background: var(--bg-secondary); font-weight: bold; border-top: 2px solid var(--border-color);">
                  <td colspan="2" style="text-align: right; padding: 1rem;">TOPLAM:</td>
                  <td style="text-align: right; color: var(--brand-red); padding: 1rem;" id="footerTotal">â‚º0.00</td>
                  <td style="text-align: right; color: #27ae60; padding: 1rem;" id="footerPaid">â‚º0.00</td>
                  <td style="text-align: right; color: #e67e22; padding: 1rem;" id="footerRemaining">â‚º0.00</td>
                  <td colspan="4"></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- Payment History -->
        <div class="card" style="margin-top: 1.5rem;">
          <h3 style="margin: 0 0 1rem 0; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);">ğŸ“œ Tahsilat GeÃ§miÅŸi</h3>
          <div id="paymentHistory" style="max-height: 400px; overflow-y: auto;">
            <div style="text-align: center; padding: 2rem; color: var(--text-secondary);">
              <div style="font-size: 2rem; margin-bottom: 0.5rem;">ğŸ“</div>
              <p style="margin: 0;">Tahsilat kaydÄ± bulunamadÄ±</p>
            </div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Record Payment Modal -->
  <div id="recordPaymentModal" class="modal">
    <div class="modal-content" style="max-width: 600px;">
      <div class="modal-header">
        <h2>ğŸ’° Ã–deme Kaydet</h2>
        <button class="modal-close" onclick="closeRecordPaymentModal()">&times;</button>
      </div>
      <div class="modal-body">
        <form id="recordPaymentForm" onsubmit="handleRecordPayment(event)">
          <div class="form-group">
            <label>HakediÅŸ SeÃ§in *</label>
            <select id="hakedisSelect" required onchange="window.updatePaymentAmount()" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-primary);">
              <option value="">ğŸ”½ HakediÅŸ SeÃ§in</option>
            </select>
            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
              â„¹ï¸ Sadece Ã¶denmemiÅŸ veya kÄ±smi Ã¶denmiÅŸ hakediÅŸ kayÄ±tlarÄ± gÃ¶steriliyor
            </small>
          </div>
          
          <!-- HakediÅŸ Bilgi KartÄ± -->
          <div id="hakedisInfoCard" style="display: none; margin-bottom: 1rem;"></div>
          
          <div class="form-group">
            <label>Ã–deme TutarÄ± (â‚º) *</label>
            <input type="number" id="paymentAmount" required min="0.01" step="0.01" placeholder="HakediÅŸ seÃ§ince otomatik dolacak" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-primary);">
            <small style="color: var(--text-secondary); font-size: 0.85rem; margin-top: 0.25rem; display: block;">
              ğŸ’¡ Kalan tutardan farklÄ± bir tutar girebilirsiniz (kÄ±smi Ã¶deme iÃ§in)
            </small>
          </div>
          <div class="form-group">
            <label>Ã–deme Tarihi *</label>
            <input type="date" id="paymentDate" required style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-primary);">
          </div>
          <div class="form-group">
            <label>Ã–deme YÃ¶ntemi</label>
            <select id="paymentMethod" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-primary);">
              <option value="bank_transfer">ğŸ¦ Banka Havalesi</option>
              <option value="check">ğŸ“ Ã‡ek</option>
              <option value="cash">ğŸ’µ Nakit</option>
              <option value="credit_card">ğŸ’³ Kredi KartÄ±</option>
              <option value="promissory_note">ğŸ“„ Senet</option>
            </select>
          </div>
          <div class="form-group">
            <label>AÃ§Ä±klama</label>
            <textarea id="paymentNotes" rows="3" placeholder="Ek notlar..." style="width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 4px; background-color: var(--input-bg); color: var(--text-primary); resize: vertical;"></textarea>
          </div>
          <div style="display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 1rem; border-top: 1px solid var(--border-color);">
            <button type="button" class="btn btn-secondary" onclick="closeRecordPaymentModal()">âŒ Ä°ptal</button>
            <button type="submit" class="btn btn-primary">ğŸ’¾ Kaydet</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module" src="../js/auth.js?v=6"></script>
  <script type="module" src="../js/projects.js?v=6"></script>
  <script type="module" src="../js/app.js?v=6"></script>

  <script>
    document.getElementById('menuToggle')?.addEventListener('click', function() {
      document.querySelector('.sidebar').classList.toggle('sidebar-open');
    });

    function updateNavLinks() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      if (projectId) {
        // Ä°ÅŸ AkÄ±ÅŸÄ± Linkleri
        const navKesif = document.getElementById('navKesif');
        const navTeklif = document.getElementById('navTeklif');
        const navSozlesme = document.getElementById('navSozlesme');
        const navMetraj = document.getElementById('navMetraj');
        const navHakedis = document.getElementById('navHakedis');
        const navOdeme = document.getElementById('navOdeme');
        // Proje & Destek Linkleri
        const navOzet = document.getElementById('navOzet');
        const navStok = document.getElementById('navStok');
        const navButce = document.getElementById('navButce');
        const navGunluk = document.getElementById('navGunluk');
        const navMusteri = document.getElementById('navMusteri');
        
        if (navKesif) navKesif.href = `kesif.html?id=${projectId}`;
        if (navTeklif) navTeklif.href = `teklif.html?id=${projectId}`;
        if (navSozlesme) navSozlesme.href = `sozlesme.html?id=${projectId}`;
        if (navMetraj) navMetraj.href = `metraj-listesi.html?id=${projectId}`;
        if (navHakedis) navHakedis.href = `hakedis-takibi.html?id=${projectId}`;
        if (navOdeme) navOdeme.href = `odeme-takibi.html?id=${projectId}`;
        if (navOzet) navOzet.href = `proje-ozeti.html?id=${projectId}`;
        if (navStok) navStok.href = `stok-yonetimi.html?id=${projectId}`;
        if (navButce) navButce.href = `butce-yonetimi.html?id=${projectId}`;
        if (navGunluk) navGunluk.href = `santiye-gunlugu.html?id=${projectId}`;
        if (navMusteri) navMusteri.href = `musteri-yetkileri.html?id=${projectId}`;
      }
    }

    function openRecordPaymentModal(hakedisId = null) {
      document.getElementById('recordPaymentModal').style.display = 'block';
      
      // Reset submit button state
      const submitBtn = document.querySelector('#recordPaymentForm button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ Kaydet';
      }
      
      // Set default date to today
      document.getElementById('paymentDate').valueAsDate = new Date();
      
      // Load hakediÅŸ options
      if (window.loadHakedisOptions) {
        window.loadHakedisOptions();
      }
      
      // If hakedisId provided, pre-select and fill amount
      if (hakedisId) {
        setTimeout(() => {
          const select = document.getElementById('hakedisSelect');
          if (select) {
            select.value = hakedisId;
            // Trigger change event to update amount
            select.dispatchEvent(new Event('change'));
          }
        }, 100);
      }
    }

    function closeRecordPaymentModal() {
      const modal = document.getElementById('recordPaymentModal');
      const form = document.getElementById('recordPaymentForm');
      const infoCard = document.getElementById('hakedisInfoCard');
      const submitBtn = form?.querySelector('button[type="submit"]');
      
      // Reset submit button state
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ’¾ Kaydet';
      }
      
      // Hide info card
      if (infoCard) {
        infoCard.style.display = 'none';
      }
      
      // Reset form
      if (form) {
        form.reset();
      }
      
      // Close modal
      if (modal) {
        modal.style.display = 'none';
      }
    }

    function syncFromHakedis() {
      if (window.synchronizeFromHakedis) {
        window.synchronizeFromHakedis();
      }
    }

    function exportPayments() {
      if (window.exportPaymentsToExcel) {
        window.exportPaymentsToExcel();
      } else {
        alert('Excel export Ã¶zelliÄŸi yakÄ±nda eklenecek');
      }
    }

    window.addEventListener('click', function(event) {
      if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
      }
    });

    updateNavLinks();
  </script>

  <script type="module">
    import { db, auth } from '../js/firebase-config.js';
    import { doc, getDoc, collection, query, where, getDocs, addDoc, updateDoc, orderBy, Timestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

    let currentProjectId = null;
    let payments = [];
    let progressPayments = [];

    async function loadPayments() {
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      
      if (!projectId) {
        window.location.href = '../projeler.html';
        return;
      }

      currentProjectId = projectId;

      try {
        const projectDoc = await getDoc(doc(db, 'projects', projectId));
        if (!projectDoc.exists()) {
          alert('âŒ Proje bulunamadÄ±');
          window.location.href = '../projeler.html';
          return;
        }

        const project = { id: projectDoc.id, ...projectDoc.data() };
        document.getElementById('projectName').textContent = project.name || 'Proje';
        document.getElementById('projectNameBreadcrumb').textContent = project.name || 'Proje';

        // Load progress payments (hakedis)
        const hakedisQuery = query(
          collection(db, 'progress_payments'),
          where('projectId', '==', projectId)
          // orderBy removed to avoid index issues
        );
        const hakedisSnap = await getDocs(hakedisQuery);
        progressPayments = [];
        
        console.log(`ğŸ“Š ${hakedisSnap.size} hakediÅŸ kaydÄ± bulundu`);
        
        hakedisSnap.forEach(docSnap => {
          progressPayments.push({ id: docSnap.id, ...docSnap.data() });
        });
        
        // Sort in memory by paymentNo or createdAt
        progressPayments.sort((a, b) => {
          const aNo = typeof a.paymentNo === 'string' ? parseInt(a.paymentNo.replace(/\D/g, '')) || 0 : (a.paymentNo || 0);
          const bNo = typeof b.paymentNo === 'string' ? parseInt(b.paymentNo.replace(/\D/g, '')) || 0 : (b.paymentNo || 0);
          return aNo - bNo;
        });

        // Load payment records
        const paymentsQuery = query(
          collection(db, 'payment_records'),
          where('projectId', '==', projectId),
          orderBy('createdAt', 'desc')
        );
        const paymentsSnap = await getDocs(paymentsQuery);
        payments = [];
        
        paymentsSnap.forEach(docSnap => {
          payments.push({ id: docSnap.id, ...docSnap.data() });
        });

        // Calculate totals
        let totalInvoiced = 0;
        let totalCollected = 0;
        let totalPending = 0;
        let totalOverdue = 0;

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        progressPayments.forEach(hakedis => {
          const netAmount = hakedis.netAmount || hakedis.netPayable || 0;
          totalInvoiced += netAmount;

          const paidRecords = payments.filter(p => p.progressPaymentId === hakedis.id);
          const paidAmount = paidRecords.reduce((sum, p) => sum + (p.amount || 0), 0);
          const remaining = netAmount - paidAmount;

          if (paidAmount >= netAmount) {
            // Fully paid
            totalCollected += netAmount;
          } else {
            const expectedDate = hakedis.expectedPaymentDate ? 
              (hakedis.expectedPaymentDate.toDate ? hakedis.expectedPaymentDate.toDate() : new Date(hakedis.expectedPaymentDate)) : 
              null;
            
            if (expectedDate && expectedDate < today) {
              totalOverdue += remaining;
            } else {
              totalPending += remaining;
            }
            
            totalCollected += paidAmount;
          }
        });

        document.getElementById('totalInvoiced').textContent = formatCurrency(totalInvoiced);
        document.getElementById('totalCollected').textContent = formatCurrency(totalCollected);
        document.getElementById('totalPending').textContent = formatCurrency(totalPending);
        document.getElementById('totalOverdue').textContent = formatCurrency(totalOverdue);
        
        const collectionRate = totalInvoiced > 0 ? (totalCollected / totalInvoiced * 100) : 0;
        document.getElementById('collectionRate').textContent = `%${collectionRate.toFixed(1)}`;

        // Update payment count
        const countEl = document.getElementById('paymentCount');
        if (countEl) countEl.textContent = progressPayments.length;

        renderPaymentsTable();
        renderPaymentHistory();
        loadHakedisOptions();

      } catch (error) {
        console.error('âŒ Error loading payments:', error);
        alert('Ã–deme verileri yÃ¼klenirken hata: ' + error.message);
      }
    }

    function renderPaymentsTable() {
      const tbody = document.getElementById('paymentsTableBody');
      const footer = document.getElementById('paymentsTableFooter');

      if (progressPayments.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="9" style="text-align: center; padding: 3rem; color: var(--text-secondary);">
              <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ’³</div>
              <p style="margin: 0; font-size: 1.1rem;">HenÃ¼z hakediÅŸ kaydÄ± yok</p>
              <p style="margin: 0.5rem 0 1rem 0;">Ã–nce hakediÅŸ oluÅŸturun, ardÄ±ndan Ã¶deme takibi yapabilirsiniz</p>
              <button class="btn btn-primary" onclick="window.syncFromHakedis()" style="margin-top: 0.5rem;">
                ğŸ”„ HakediÅŸ Verilerini Senkronize Et
              </button>
            </td>
          </tr>
        `;
        footer.style.display = 'none';
        return;
      }

      const statusBadges = {
        pending: { class: 'status-pending', text: 'â³ Bekleyen' },
        partial: { class: 'status-partial', text: 'ğŸ”µ KÄ±smi' },
        paid: { class: 'status-paid', text: 'âœ… Ã–dendi' },
        overdue: { class: 'status-overdue', text: 'âš ï¸ GecikmiÅŸ' }
      };

      let html = '';
      let totalAmount = 0;
      let totalPaid = 0;
      let totalRemaining = 0;
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      progressPayments.forEach(hakedis => {
        const netAmount = hakedis.netAmount || hakedis.netPayable || 0;
        totalAmount += netAmount;

        const paidRecords = payments.filter(p => p.progressPaymentId === hakedis.id);
        const paidAmount = paidRecords.reduce((sum, p) => sum + (p.amount || 0), 0);
        const remaining = netAmount - paidAmount;
        totalPaid += paidAmount;
        totalRemaining += remaining;

        let status = 'pending';
        if (paidAmount >= netAmount) {
          status = 'paid';
        } else if (paidAmount > 0) {
          status = 'partial';
        } else {
          const expectedDate = hakedis.expectedPaymentDate ? 
            (hakedis.expectedPaymentDate.toDate ? hakedis.expectedPaymentDate.toDate() : new Date(hakedis.expectedPaymentDate)) : 
            null;
          if (expectedDate && expectedDate < today) {
            status = 'overdue';
          }
        }

        const statusBadge = statusBadges[status];

        const lastPayment = paidRecords.length > 0 ? paidRecords[paidRecords.length - 1] : null;
        const paymentDateStr = lastPayment && lastPayment.paymentDate ? 
          (lastPayment.paymentDate.toDate ? lastPayment.paymentDate.toDate() : new Date(lastPayment.paymentDate)).toLocaleDateString('tr-TR') : 
          '-';

        const expectedDateStr = hakedis.expectedPaymentDate ? 
          (hakedis.expectedPaymentDate.toDate ? hakedis.expectedPaymentDate.toDate() : new Date(hakedis.expectedPaymentDate)).toLocaleDateString('tr-TR') : 
          '-';
        
        // Get payment number (can be string like 'HAK-005' or number like 1)
        const paymentNoDisplay = hakedis.paymentNo || '#' + (progressPayments.indexOf(hakedis) + 1);

        html += `
          <tr>
            <td><strong>${paymentNoDisplay}</strong></td>
            <td>${hakedis.period || hakedis.periodName || 'DÃ¶nem belirtilmemiÅŸ'}</td>
            <td style="text-align: right;"><strong>${formatCurrency(netAmount)}</strong></td>
            <td style="text-align: right; color: #27ae60;">${formatCurrency(paidAmount)}</td>
            <td style="text-align: right; color: ${remaining > 0 ? '#e67e22' : '#27ae60'};">${formatCurrency(remaining)}</td>
            <td>${expectedDateStr}</td>
            <td>${paymentDateStr}</td>
            <td><span class="status-badge ${statusBadge.class}">${statusBadge.text}</span></td>
            <td>
              ${remaining > 0.01 ? `
                <button 
                  class="btn btn-primary" 
                  style="padding: 0.5rem 0.75rem; white-space: nowrap; font-size: 0.85rem;" 
                  onclick="recordPaymentFor('${hakedis.id}')"
                  title="Ã–deme kaydet"
                >
                  ğŸ’° Ã–deme Kaydet
                </button>
              ` : `
                <span style="color: #27ae60; font-weight: 600; font-size: 0.85rem;">âœ… TamamlandÄ±</span>
              `}
            </td>
          </tr>
        `;
      });

      tbody.innerHTML = html;
      footer.style.display = 'table-footer-group';
      document.getElementById('footerTotal').textContent = formatCurrency(totalAmount);
      document.getElementById('footerPaid').textContent = formatCurrency(totalPaid);
      document.getElementById('footerRemaining').textContent = formatCurrency(totalRemaining);
    }

    function renderPaymentHistory() {
      const historyDiv = document.getElementById('paymentHistory');
      
      if (payments.length === 0) {
        historyDiv.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--text-secondary);">Tahsilat kaydÄ± bulunamadÄ±</div>';
        return;
      }

      const methodNames = {
        bank_transfer: 'ğŸ¦ Banka Havalesi',
        check: 'ğŸ“ Ã‡ek',
        cash: 'ğŸ’µ Nakit',
        credit_card: 'ğŸ’³ Kredi KartÄ±',
        promissory_note: 'ğŸ“œ Senet'
      };

      let html = '<div style="display: flex; flex-direction: column; gap: 1rem;">';
      
      payments.forEach(payment => {
        const hakedis = progressPayments.find(h => h.id === payment.progressPaymentId);
        const paymentDate = payment.paymentDate ? 
          (payment.paymentDate.toDate ? payment.paymentDate.toDate() : new Date(payment.paymentDate)).toLocaleDateString('tr-TR') : 
          '-';

        html += `
          <div style="padding: 1rem; background: white; border-radius: 8px; border-left: 4px solid #27ae60;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
              <strong>${hakedis ? `HAK-${hakedis.periodNo}` : 'HakediÅŸ Bilinmiyor'}</strong>
              <span style="color: #27ae60; font-weight: bold;">${formatCurrency(payment.amount)}</span>
            </div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">
              ğŸ“… ${paymentDate} â€¢ ${methodNames[payment.method] || payment.method}
              ${payment.notes ? `<br>ğŸ’¬ ${payment.notes}` : ''}
            </div>
          </div>
        `;
      });

      html += '</div>';
      historyDiv.innerHTML = html;
    }

    function loadHakedisOptions() {
      const select = document.getElementById('hakedisSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">ğŸ”½ HakediÅŸ SeÃ§in</option>';
      
      if (progressPayments.length === 0) {
        select.innerHTML += '<option value="" disabled>âŒ HakediÅŸ bulunamadÄ±</option>';
        return;
      }
      
      let hasUnpaid = false;
      
      progressPayments.forEach(hakedis => {
        const netAmount = hakedis.netAmount || hakedis.netPayable || 0;
        const paidRecords = payments.filter(p => p.progressPaymentId === hakedis.id);
        const paidAmount = paidRecords.reduce((sum, p) => sum + (p.amount || 0), 0);
        const remaining = netAmount - paidAmount;

        // Show only hakediÅŸ with remaining amount
        if (remaining > 0.01) {
          hasUnpaid = true;
          const paymentNo = hakedis.paymentNo || `#${progressPayments.indexOf(hakedis) + 1}`;
          const period = hakedis.period || hakedis.periodName || 'DÃ¶nem belirtilmemiÅŸ';
          const percentage = netAmount > 0 ? ((paidAmount / netAmount) * 100).toFixed(0) : 0;
          
          select.innerHTML += `
            <option value="${hakedis.id}" data-remaining="${remaining.toFixed(2)}" data-net="${netAmount.toFixed(2)}" data-paid="${paidAmount.toFixed(2)}">
              ${paymentNo} - ${period} | Toplam: ${formatCurrency(netAmount)} | Ã–denen: ${formatCurrency(paidAmount)} (${percentage}%) | ğŸ’° Kalan: ${formatCurrency(remaining)}
            </option>
          `;
        }
      });
      
      if (!hasUnpaid) {
        select.innerHTML += '<option value="" disabled>âœ… TÃ¼m hakediÅŸ Ã¶demeleri tamamlandÄ±</option>';
      }
    }

    // HakediÅŸ seÃ§ildiÄŸinde kalan tutarÄ± otomatik doldur
    window.updatePaymentAmount = function() {
      const select = document.getElementById('hakedisSelect');
      const amountInput = document.getElementById('paymentAmount');
      const infoCard = document.getElementById('hakedisInfoCard');
      
      if (!select || !amountInput) return;
      
      const selectedOption = select.options[select.selectedIndex];
      if (!selectedOption || !selectedOption.value) {
        amountInput.value = '';
        if (infoCard) infoCard.style.display = 'none';
        return;
      }
      
      const remaining = parseFloat(selectedOption.dataset.remaining || 0);
      const netAmount = parseFloat(selectedOption.dataset.net || 0);
      const paidAmount = parseFloat(selectedOption.dataset.paid || 0);
      
      amountInput.value = remaining.toFixed(2);
      amountInput.max = remaining.toFixed(2);
      
      // Show info card
      if (infoCard) {
        const percentage = netAmount > 0 ? ((paidAmount / netAmount) * 100).toFixed(1) : 0;
        infoCard.innerHTML = `
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; padding: 1rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; color: white;">
            <div style="text-align: center;">
              <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Toplam Tutar</div>
              <div style="font-size: 1.1rem; font-weight: bold;">${formatCurrency(netAmount)}</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">Ã–denen (${percentage}%)</div>
              <div style="font-size: 1.1rem; font-weight: bold;">${formatCurrency(paidAmount)}</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 0.75rem; opacity: 0.9; margin-bottom: 0.25rem;">ğŸ’° Kalan</div>
              <div style="font-size: 1.1rem; font-weight: bold;">${formatCurrency(remaining)}</div>
            </div>
          </div>
        `;
        infoCard.style.display = 'block';
      }
    };
    
    window.recordPaymentFor = function(hakedisId) {
      openRecordPaymentModal(hakedisId);
    };

    async function handleRecordPayment(event) {
      event.preventDefault();
      
      // Prevent double submit
      const submitBtn = event.target.querySelector('button[type="submit"]');
      if (submitBtn && submitBtn.disabled) {
        console.log('âš ï¸ Already submitting, ignoring duplicate submit');
        return;
      }

      const hakedisId = document.getElementById('hakedisSelect').value;
      const amount = parseFloat(document.getElementById('paymentAmount').value);
      const paymentDate = document.getElementById('paymentDate').value;
      const method = document.getElementById('paymentMethod').value;
      const notes = document.getElementById('paymentNotes').value;

      // Validation
      if (!hakedisId) {
        alert('âš ï¸ LÃ¼tfen hakediÅŸ seÃ§in!');
        return;
      }

      if (!amount || amount <= 0) {
        alert('âš ï¸ LÃ¼tfen geÃ§erli bir Ã¶deme tutarÄ± girin!');
        return;
      }

      // Check if amount exceeds remaining
      const hakedis = progressPayments.find(h => h.id === hakedisId);
      if (hakedis) {
        const netAmount = hakedis.netAmount || hakedis.netPayable || 0;
        const paidRecords = payments.filter(p => p.progressPaymentId === hakedisId);
        const paidAmount = paidRecords.reduce((sum, p) => sum + (p.amount || 0), 0);
        const remaining = netAmount - paidAmount;

        if (amount > remaining + 0.01) {
          const confirmResult = window.confirm(
            `âš ï¸ UYARI: Girilen tutar kalan tutarÄ± aÅŸÄ±yor!\n\n` +
            `Kalan Tutar: ${formatCurrency(remaining)}\n` +
            `Girilen Tutar: ${formatCurrency(amount)}\n` +
            `Fark: ${formatCurrency(amount - remaining)}\n\n` +
            `Devam etmek istiyor musunuz?`
          );
          if (!confirmResult) return;
        }
      }

      try {
        const user = auth.currentUser;
        
        // Show loading state
        if (submitBtn) {
          submitBtn.disabled = true;
          submitBtn.textContent = 'â³ Kaydediliyor...';
        }

        await addDoc(collection(db, 'payment_records'), {
          projectId: currentProjectId,
          progressPaymentId: hakedisId,
          amount,
          paymentDate: Timestamp.fromDate(new Date(paymentDate)),
          method,
          notes: notes.trim(),
          createdAt: Timestamp.now(),
          createdBy: user.uid,
          createdByEmail: user.email
        });

        // Success message with details
        const methodNames = {
          'bank_transfer': 'Banka Havalesi',
          'check': 'Ã‡ek',
          'cash': 'Nakit',
          'credit_card': 'Kredi KartÄ±',
          'promissory_note': 'Senet'
        };

        alert(
          `âœ… Ã–deme baÅŸarÄ±yla kaydedildi!\n\n` +
          `ğŸ’° Tutar: ${formatCurrency(amount)}\n` +
          `ğŸ“… Tarih: ${new Date(paymentDate).toLocaleDateString('tr-TR')}\n` +
          `ğŸ¦ YÃ¶ntem: ${methodNames[method] || method}\n\n` +
          `Tabloda gÃ¼ncellenmiÅŸ durumu gÃ¶rebilirsiniz.`
        );
        
        closeRecordPaymentModal();
        await loadPayments();

      } catch (error) {
        console.error('âŒ Error recording payment:', error);
        alert('âŒ Ã–deme kaydedilirken hata oluÅŸtu:\n\n' + error.message + '\n\nLÃ¼tfen tekrar deneyin.');
        
        // Reset button
        const submitBtn = event.target.querySelector('button[type="submit"]');
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.textContent = 'ğŸ’¾ Kaydet';
        }
      }
    }

    window.syncFromHakedis = async function() {
      try {
        console.log('ğŸ”„ HakediÅŸ senkronizasyonu baÅŸlatÄ±lÄ±yor...');
        console.log('ğŸ“ Project ID:', currentProjectId);
        
        if (!currentProjectId) {
          alert('âš ï¸ Proje ID bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.');
          return;
        }
        
        // Query without orderBy to avoid index requirements
        const hakedisQuery = query(
          collection(db, 'progress_payments'),
          where('projectId', '==', currentProjectId)
        );
        
        console.log('ğŸ“Š Sorgu Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...');
        console.log('ğŸ“Œ Sorgu detayÄ±:', {
          collection: 'progress_payments',
          projectId: currentProjectId
        });
        
        const hakedisSnap = await getDocs(hakedisQuery);
        
        console.log('ğŸ“¦ Bulunan hakediÅŸ sayÄ±sÄ±:', hakedisSnap.size);
        
        if (!hakedisSnap.empty) {
          console.log('âœ… Bulunan hakediÅŸ kayÄ±tlarÄ±:');
          hakedisSnap.forEach(doc => {
            const data = doc.data();
            console.log('  -', {
              id: doc.id,
              paymentNo: data.paymentNo,
              period: data.period,
              grossAmount: data.grossAmount,
              netAmount: data.netAmount,
              status: data.status
            });
          });
        }
        
        if (hakedisSnap.empty) {
          console.warn('âš ï¸ HakediÅŸ kaydÄ± bulunamadÄ±');
          alert('âŒ Bu proje iÃ§in hakediÅŸ kaydÄ± bulunamadÄ±.\n\n' +
                'Firestore\'da progress_payments collection\'Ä±nda bu proje ID ile kayÄ±t yok.\n\n' +
                'Proje ID: ' + currentProjectId + '\n\n' +
                'LÃ¼tfen Ã¶nce "HakediÅŸ Takibi" sayfasÄ±ndan hakediÅŸ oluÅŸturun.');
          
          const shouldNavigate = confirm('HakediÅŸ sayfasÄ±na gitmek ister misiniz?');
          if (shouldNavigate) {
            window.location.href = `hakedis-takibi.html?id=${currentProjectId}`;
          }
          return;
        }

        alert(`âœ… ${hakedisSnap.size} hakediÅŸ kaydÄ± bulundu!\n\n` +
              'HakediÅŸ verileri Ã¶deme listesine senkronize edildi.');
        loadPayments();

      } catch (error) {
        console.error('âŒ HakediÅŸ senkronizasyon hatasÄ±:', error);
        console.error('Hata detayÄ±:', {
          message: error.message,
          code: error.code,
          stack: error.stack
        });
        alert('âŒ Senkronizasyon hatasÄ±:\n\n' + error.message + 
              '\n\nFirestore hatasÄ±: ' + (error.code || 'Bilinmeyen') +
              '\n\nDetaylar console\'da (F12) gÃ¶rÃ¼lebilir.');
      }
    };

    window.handleRecordPayment = handleRecordPayment;

    function formatCurrency(amount) {
      return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY',
        minimumFractionDigits: 2
      }).format(amount || 0);
    }

    setTimeout(() => {
      loadPayments();
    }, 200);

    // Filter
    document.getElementById('statusFilter')?.addEventListener('change', () => loadPayments());
  </script>
</body>
</html>
